{% extends 'base.html' %}
{% load static %}
{% block content %}

	<h1>Salesforce Switch</h1>
	<p>
		This tool provides an interface to easily enable and disable components in your Salesforce Org - Workflows, Triggers and Validation Rules. Very useful when doing data migrations and needing to disable certain automation.
	</p>
	<p>
		None of your organization information or data is captured or kept from running this tool.
	</p>
				
	<div class="loading-components">
		<div style="float:left;">
			<img src="{% static 'images/loading.gif' %}" alt="Loading" title="Loading" />
		</div>
		<div style="float:left;margin-left:20px;">
			<h1 style="font-size:1.5em;margin-top:20px;">Querying metadata</h1>
			<p>Building a list of Org Metadata...</p>
			<i class="status_message"></i>
		</div>
	</div>

	<div class="loading-metadata">
		<div style="float:left;">
			<img src="{% static 'images/loading.gif' %}" alt="Loading" title="Loading" />
		</div>
		<div style="float:left;margin-left:20px;">
			<h1 style="font-size:1.5em;margin-top:20px;">Querying metadata</h1>
			<i class="status_message"></i>
		</div>
	</div>

	<div class="error" style="display:none;">
		<div class="alert alert-danger" role="alert">
			<p>
				There was an error processing your request: <i class="error_message"></i>
				<br/><br/>
				<!-- Please <a href="/{% if request.GET.noheader == '1' %}?noheader=1{% endif %}">return</a> to the home page and try again. -->
				Please <a href="/">return</a> to the home page and try again.
				
			</p>
		</div>
	</div>

	<script>
 		window.setInterval(function () 
 		{
			// Create an ajax request 
       		$.ajax({
				// Get the job status for specific job Id
			    url: '/job_status/{{ job.random_id }}',
			    type: 'get', //this is the default though, you don't actually need to always mention it
			    dataType: 'json',
				// If the request is successful, process the response
			    success: function(resp) {
					// Look at the status field, if finished 
			        if (resp.status == 'Finished') {
			        	// window.location = '/job/{{ job.random_id }}/{% if request.GET.noheader == "1" %}?noheader=1{% endif %}';
						window.location = '/job/{{ job.random_id }}/';
			        } 
			        else if (resp.status == 'Error') {
			        	$('.loading-components').hide();
			        	$('.error').show();
			        	$('.error_message').text(resp.error);
			        }

					else if (resp.status == 'Retrieving Validation Rules from Org...') {
						$('.loading-components').hide();
			        	$('.loading-metadata').show();
						$('.status_message').text(resp.status);
					}

					 else {// Else job is still running, update to latest status
						$('.loading-components').hide();
			        	$('.loading-metadata').show();
						$('.status_message').text(resp.status);
					}
			    },
				// Request was not successful, handle the response by removing the 
			    failure: function(resp) 
			    { 
			        $('.loading-components').hide();
		        	$('.error').show();
		        	$('.error_message').text(resp);
			    }
			});
    	}, 3000);
	</script>

{% endblock %}